platform :ios, '13.0'
use_frameworks! :linkage => :static
use_modular_headers!

flutter_application_root = File.expand_path('..', __dir__)

target 'Runner' do
  config = ENV['CONFIGURATION'] || 'Release'
  flutter_engine_dir = File.expand_path(File.join(__dir__, 'Flutter', config))
  pod 'Flutter', :path => flutter_engine_dir

  plugin_file = File.expand_path(File.join(flutter_application_root, '.flutter-plugins-dependencies'))
  if File.exist?(plugin_file)
    require 'json'
    ios_plugins = (JSON.parse(File.read(plugin_file))['plugins'] || {})['ios'] || []
    ios_plugins.each do |p|
      plugin_path = p['path']
      ios_dir =
        if plugin_path.start_with?('/')
          File.join(plugin_path, 'ios')
        else
          File.expand_path(File.join(flutter_application_root, plugin_path, 'ios'))
        end
      pod p['name'], :path => ios_dir
    end
  end
end

post_install do |installer|
  installer.pods_project.targets.each do |t|
    t.build_configurations.each do |c|
      c.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
      c.build_settings['BUILD_LIBRARY_FOR_DISTRIBUTION'] = 'YES'
    end
  end
end

